<!doctype html><html lang=zh-cn dir=content/zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=content-security-policy content="upgrade-insecure-requests"><title>容器学习笔记 - 现实和梦想</title><meta name=keywords content="博客,程序员,架构,学习,思考,读书,笔记,技术,分享,开发"><meta name=author content="菩提本树"><meta property="og:title" content="容器学习笔记"><meta property="og:site_name" content="现实和梦想"><meta property="og:image" content="/img/author.jpg"><meta name=title content="容器学习笔记 - 现实和梦想"><meta name=description content="欢迎来到jansonlv博客空间，个人主要专注于程序开发，架构"><link rel="shortcut icon" href=/img/favicon.ico><link rel=apple-touch-icon href=/img/apple-touch-icon.png><link rel=apple-touch-icon-precomposed href=/img/apple-touch-icon.png><link href=//cdn.bootcdn.net/ajax/libs/font-awesome/4.6.2/css/font-awesome.min.css rel=stylesheet type=text/css><link href=//cdn.bootcdn.net/ajax/libs/imageviewer/0.1.0/viewer.min.css rel=stylesheet><link href=/css/main.css rel=stylesheet type=text/css><link href=/css/syntax.css rel=stylesheet type=text/css><script type=text/javascript>var _hmt=_hmt||[];(function(){var a=document.createElement("script"),b;a.src="https://hm.baidu.com/hm.js?Your BaiduSiteId",b=document.getElementsByTagName("script")[0],b.parentNode.insertBefore(a,b)})()</script><script async src="https://www.googletagmanager.com/gtag/js?id=Your%20GoogleSiteId"></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','Your GoogleSiteId ')</script></head><body itemscope itemtype=http://schema.org/WebPage lang=zh-hans><div class="container one-collumn sidebar-position-left page-home"><div class=headband></div><header id=header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle role=button style=opacity:1;top:0><span class=toggle-line></span><span class=toggle-line></span><span class=toggle-line></span></div></div><div class=site-meta><div class=multi-lang-switch><i class="fa fa-fw fa-language" style=margin-right:5px></i>
<a class=lang-link id=zh-cn href=#>中文</a></div><div class=custom-logo-site-title><a href=/ class=brand rel=start><span class=logo-line-before><i></i></span>
<span class=site-title>现实和梦想</span>
<span class=logo-line-after><i></i></span></a></div><p class=site-subtitle>jansonlv</p></div><div class=site-nav-right><div class="toggle popup-trigger" style=opacity:1;top:0><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul id=menu class=menu><li class=menu-item><a href=/ rel=section><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class=menu-item><a href=/post rel=section><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class=menu-item><a href=/about.html rel=section><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于我</a></li><li class=menu-item><a href=/404.html rel=section><i class="menu-item-icon fa fa-fw fa-heartbeat"></i><br>公益404</a></li><li class="menu-item menu-item-search"><a href=javascript:; class=popup-trigger><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class=site-search><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class=search-icon><i class="fa fa-search"></i></span>
<span class=popup-btn-close><i class="fa fa-times-circle"></i></span><div class=local-search-input-wrapper><input autocomplete=off placeholder=搜索关键字... spellcheck=false type=text id=local-search-input autocapitalize=none autocorrect=off></div></div><div id=local-search-result></div></div></div></nav></div></header><main id=main class=main><div class=main-inner><div class=content-wrap><div id=content class=content><section id=posts class=posts-expand><article class="post post-type-normal" itemscope itemtype=http://schema.org/Article><header class=post-header><h1 class=post-title itemprop="name headline"><a class=post-title-link href=/post/docker_learn_note/ itemprop=url>容器学习笔记</a></h1><div class=post-meta><span class=post-time><i class="fa fa-calendar-o fa-fw"></i>
<span class=post-meta-item-text>时间：</span>
<time itemprop=dateCreated datetime=2016-03-22T13:04:35+08:00 content="2021-09-17">2021-09-17</time></span>
<span class=post-category>&nbsp; | &nbsp;
<i class="fa fa-folder-o fa-fw"></i>
<span class=post-meta-item-text>分类：</span>
<span itemprop=about itemscope itemtype=https://schema.org/Thing><a href=/categories/%E5%AD%A6%E4%B9%A0 itemprop=url rel=index style=text-decoration:underline><span itemprop=name>学习</span></a>
&nbsp;</span></span>
<span>|
<i class="fa fa-file-word-o fa-fw"></i>
<span class=post-meta-item-text>字数：</span>
<span class=leancloud-world-count>7172 字</span></span>
<span>|
<i class="fa fa-eye fa-fw"></i>
<span class=post-meta-item-text>阅读：</span>
<span class=leancloud-view-count>15分钟</span></span>
<span id=/post/docker_learn_note/ class=leancloud_visitors data-flag-title=容器学习笔记>|
<i class="fa fa-binoculars fa-fw"></i>
<span class=post-meta-item-text>阅读次数：</span>
<span class=leancloud-visitors-count></span></span></div></header><div class=post-body itemprop=articleBody><h1 id=容器技术>容器技术</h1><ol><li>行为算法的区别（容器cpu和宿主机cpu占用率计算方式区别）</li><li>隔离程度：cpu，memory，IO</li><li>处理性能敏感的应用，需要做cgroup，网络优化等两个重点：</li><li>Namespace和Cgroups</li><li>Namespace和Cgroups对Linux原来模块的影响</li></ol><h2 id=namespaces>Namespaces</h2><p>linux创建容器的时候，就会建出PID Namespace，在这个pid namespace中只能看到namespace中的进程，而且看不到其他的namespace里的进程</p><p>所以namespace其实就是一个隔离机制，主要目的是隔离运行在同一个宿主机上的容器，让这些容器不能彼此访问彼此的资源</p><p>作用：</p><ol><li>充分利用系统的资源，也即是同一个宿主机可以运行多个用户的容器</li><li>保证安全性，同一个用户之间不嫩个访问对方的资源</li></ol><p>除了pid namespace（进程隔离）还有network namespace（网络隔离），mount namespace（文件隔离）统称资源隔离。</p><p>其实还有：user(用户和用户组)、uts（主机名与域名），ipc（信号量、消息队列和共享内存）隔离</p><h2 id=cgroups>Cgroups</h2><p>对计算机资源的限制，比如cpu的限制，内存的使用量，IO设备的流量。</p><p>通过不同的子系统限制不同资源</p><p>常用的Cgroups子系统：</p><ol><li>CPU子系统，用来限制一个控制组（可理解为一个容器内所有进程）可使用的最大CPU</li><li>memory子系统，限制控制组最大的内存使用量</li><li>pids子系统，用来限制一个控制组最多可以运行多少进程</li><li>cpuset子系统：限制控制组的进行可以在几个物理cpu上运行</li></ol><h2 id=进程信号处理>进程信号处理</h2><h3 id=忽略>忽略</h3><p>对信号不做任何处理</p><h3 id=捕获>捕获</h3><p>用户进程自己注册信号handler</p><h3 id=缺省>缺省</h3><p>Linux为每个信号都定义了一个缺省的行为，对大部分的信号，用户不需要自己注册handler，使用系统的缺省定义行为即可</p><blockquote><p>注意： kill和stop除外，因为这是内核和超级用户删除任何进程的特权，只能有执行系统处理，用户不能单独处理</p></blockquote><h3 id=重点信号>重点信号</h3><h4 id=sigterm>SIGTERM</h4><p>这个信号是kill缺省发出的。可以由用户注册handler去捕获</p><h4 id=sigkill>SIGKILL</h4><p>这个是特权信号，杀死进程</p><p>最终可有确定两个</p><ol><li>在容器中是不工作的，内核阻止了 1 号进程对 SIGKILL 特权信号的响应。</li><li>kill 分两种情况，如果 1 号进程没有注册 SIGTERM 的 handler，那么对 SIGTERM 信号也不响应，如果注册了 handler，那么就可以响应 SIGTERM 信号。
3. 在容器中，1号进程永远不会响应SIGKILL和SIGSTOP这两个特权信号。</li></ol><h3 id=为什么要防止僵尸进程>为什么要防止僵尸进程</h3><p>限制cgroup的进程数量限制，一旦超过进程数量，那么正常进程无法正常启动，且僵尸进程无法被杀死</p><h3 id=为什么容器中的进程被杀死了>为什么容器中的进程被杀死了</h3><p>1当docker停止一个容器的时候，containerd服务会向容器的init进程发送一个SIGTERM信号，没有相应即30s之后给当前进程发送SIGKILL，当前进程关闭后给子进程发送SIGKILL。但是SIGKILL是不能捕获的</p><p>linux命令：strace -p pid</p><h3 id=如何限制cpu>如何限制cpu</h3><p>关注top下的Cpu</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>$ top
%Cpu(s):  0.1 us,  0.1 sy,  0.0 ni, 99.8 id,  0.0 wa,  0.0 hi,  0.0 si
</code></pre></div><p>us: 用户程序代码
sy: 系统调用，比如读取文件的系统调用过程
wa: io等待时间，读取文件时交给了总线DMA操作
id： 空闲状态
hi：cpu硬中断时间
si：software interrupt软件中断，软中断
ni：nice，nice值1-19的进程用户态cpu时间
st：steal，表示同一个宿主机上的其他虚拟机抢走的cpu时间</p><p>cpu的cgroup一般限制的是us和ni，还有一部分内核态sy</p><h4 id=cpu-cgroups限制参数>cpu cgroups限制参数</h4><p>cpu的Cgroups有三个参数</p><ol><li>cpu.cfs_quota_us：cfs算法的一个调度周期，一般值为100000，也就是100ms</li><li>cpu.cfs_period_us：cfs算法中在一个调度周期里这个控制组被允许允许时间，比如值是50000，就是50ms</li><li>cpu.shares：控制组之间的cpu分配比例，缺省值1024</li></ol><h3 id=如何正确的获取容器cpu开销>如何正确的获取容器cpu开销</h3><p>首先，在容器中的top中的cpu是反应的宿主机的cpu情况
。。。。。</p><h3 id=为什么容器很慢>为什么容器很慢</h3><p>继续top
load average: 系统中可运行队列中进程数量+休眠队列中不可打断的进程平均数
如果load average值升高，且应用性能下降，真正的原因是什么？
ps aux | grep &ldquo;D&rdquo;
这样子可以找到有哪些进程休眠且不可被打断了。
D状态主要是因为disk i/o的党文和信号量的锁党文，因此,D状态在linux中很常见，这是一种对资源的竞争。</p><p>D状态引起的容器性能下降问题是CGroup无法解决的，因为资源的竞争是全局的</p><h3 id=容器为什么被kill掉的>容器为什么被kill掉的</h3><p>原因：容器中的进程使用了太多的内存，超过了memory cgroup的内存限制，linux就会主动杀死容器内的进程，可能造成整个容器退出
命令：查看容器退出原因 docker inspect 容器id | grep -i Status -A 10</p><h4 id=memory-cgroups>memory Cgroups</h4><p>和cpu的 cgroups一样有三个参数</p><ol><li>memory.limit_in_bytes：限制控制组中所有进程可使用的内存最大值</li><li>memory.oom_control：当limit_in_bytes满足时触发的行为，默认OOM Killer</li><li>memory_usage_in_bytes：当前控制组中所有进程实际使用的内存总和</li></ol><p>如何确定容器发生了OOM，可以通过内核日志及时发现</p><ol><li>使用journal -k</li><li>查看/var/log/message</li></ol><h3 id=为什么容量总是在使用临界点>为什么容量总是在使用临界点</h3><p>涉及到用户态相关的两个内存类型：RSS和Page Cache</p><ol><li>RSS：进程真正申请到物理页面的内存大小，因为malloc分配的内存是虚拟地址，但没有被使用，其RSS为0，只有使用了才会有物理页面，而且实际使用多少，RSS就是多少。</li><li>Page Cache：进程对文件读写操作时，系统会分配内存将磁盘上读写到的页面放到内存中的数据。</li></ol><p>如果系统中有空闲的内存，系统就会自动把读写过的磁盘文件放到page cache中，如果内存不够了，就会进行内存管理机制进行内存回收。
PageCache只是启动缓存作用，因此会被优先回收释放</p><p>linux命令：查看具体的内存使用量：cat memory.stat</p><h3 id=容器可以使用swap空间吗>容器可以使用Swap空间吗？</h3><p>本质上是可以使用swap空间的
但是内存泄露的进程没有被杀死，还会不断的读写swap磁盘，影响了整个节点的性能。
最终就是一个平衡点的，参考功能原理：swappiness
swappiness取值范围：
100：脂肪page cache和匿名内存是同等优先级
60：默认值，page cache的释放优先级高于匿名内存的释放
0：当系统中内存低于临界值时，仍然会释放匿名内存并把页面写写入到swap空间</p><h3 id=在容器中读写文件变慢了>在容器中读写文件变慢了</h3><ol><li>容器文件系统的不支持</li></ol><h4 id=容器文件系统>容器文件系统</h4><p>Linux命令：pref</p><ul><li>减少相同镜像文件在同一个节点的数据冗余们可以节省磁盘空间，也可以减少镜像文件下载的网络资源</li><li>UnionFS作为容器文件系统，是通过多个目录挂在的方式工作</li><li>OverlayFS是UnionFS的一种实现，是目前主流Linux版本中的使用的容器文件系统</li><li>OverlayFS是吧多个目录合并挂载，被挂载的目录分为两大类：lowerdir和upperdir</li><li>lowerdir允许有多个目录，被挂载之后这些文件是不会被删除和修改的，也就是只读</li><li>upperdir只有一个，是可读写的，挂载点的目录中所有的文件修改都会在upperdir中反应</li></ul><h3 id=容器文件quota容器为什么把宿主机的磁盘写满了>容器文件Quota：容器为什么把宿主机的磁盘写满了</h3><p>容器写入的文件都是直接写入到宿主机上的，因此有可能让把宿主机写满</p><p>那如何都写入做限流呢？</p><ol><li>linux都是使用的xfs和ext4文件系统</li><li>使用Quota进行对一个用户，一个用户组，或者一个项目限制他们使用文件系统的额度（quota）</li><li>具体方案
4. 给目标目录打赏一个Project ID
5. 给这个Project ID在XFS文件系统中设置一个写入数据块的限制</li></ol><p>Docker就是使用了这个方法，用XFS Quote来限制OverlayFS的upperdir目标，通过这个方式控制同期OverlayFS根目录大小</p><h3 id=容器里磁盘读写不稳定>容器里磁盘读写不稳定</h3><p>具体来说就是多个容器同时读写节点上的同一块磁盘，那么他们的磁盘读写相互之间的影响如何解决。
Linux命令： fio</p><p>通过fio命令进行测试，发现多个同期同时写一块磁盘的时候，它的性能受到了干扰。</p><p>之前，我们用Cgroups来保证容器的CPU使用率，以及控制memory的可用大小，我们是不是也可以通过Cgroups来保证容器的磁盘读写性能？</p><p>在Cgroups v1中有一个blkio子系统，用来限制磁盘IO的</p><p>磁盘两个常见指标</p><ol><li>IOPS：每秒钟磁盘读写次数</li><li>throughput：每秒钟磁盘数据吞吐量也可以成为带宽
两者关系是：吞吐量=数据块大小 * IOPS</li></ol><p>在blkio Cgroups中有四个主要的参数，用来限制磁盘的io性能</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>blkio.throttle.read_iops_device 
blkio.throrrle.read_bps_device // 吞吐量
blkio.throttle.write_iops_device
blkio.throrrle.write_bps_device
</code></pre></div><p>但是该模式是Linux系统下的Direct IO模式</p><p>Linux有两者文件IO模式：Direct IO和Buffered IO。</p><p>DirectIO：文件系统层->块设备层->磁盘驱动->磁盘硬件写入
BufferedIO: 用户进程吧文件数据写入到内存中就返回了，Linux自由的线程会通过DMA模式，写入到磁盘中</p><p>DirectIO可以用通过blkio限制磁盘IO，但是bufferedIO不能被限制</p><p>如何限制bufferedIO呢？
这就需要Cgroups v2了</p><ol><li>第一步打开Cgroups v2的功能，因为限制及时最新的linux系统也是默认关闭的</li><li>在进行设（百）置（度）</li></ol><h3 id=容器中的内存与io容器写文件的延时为什么波动很大>容器中的内存与I/O：容器写文件的延时为什么波动很大？</h3><p>在Linux默认系统调用下，buffered io是默认模式，使用方便</p><p>但是在容器中使用的话，发现多了memory cgroup限制之后，write写相同大小的数据块花费的的时间，延时波动比较大</p><p>这是为什么呢？
Linux命令：perf和ftrace</p><p>由于这是 Buffered I/O 方式，对于写入文件会先写到内存里，这样就产生了 dirty pages，所以我们先研究了一下 Linux 对 dirty pages 的回收机制是否会影响到容器中写入数据的波动。</p><p>在这里我们最主要的是理解这两个参数，dirty_background_ratio 和 dirty_ratio，这两个值都是相对于节点可用内存的百分比值。</p><p>当 dirty pages 数量超过 dirty_background_ratio 对应的内存量的时候，内核 flush 线程就会开始把 dirty pages 写入磁盘 ; 当 dirty pages 数量超过 dirty_ratio 对应的内存量，这时候程序写文件的函数调用 write() 就会被阻塞住，直到这次调用的 dirty pages全部写入到磁盘。</p><p>在节点是大内存容量，并且 dirty_ratio 为系统缺省值 20%，dirty_background_ratio 是系统缺省值 10% 的情况下，我们通过观察 /proc/vmstat 中的 nr_dirty 数值可以发现，dirty pages 不会阻塞进程的 Buffered I/O 写文件操作。
所以我们做了另一种尝试，使用 perf 和 ftrace 工具对容器中的写文件进程进行 profile。我们用 perf 得到了系统调用 write() 在内核中的一系列子函数调用，再用 ftrace 来查看这些子函数的调用时间。</p><p>根据 ftrace 的结果，我们发现写数据到 Page Cache 的时候，需要不断地去释放原有的页面，这个时间开销是最大的。造成容器中 Buffered I/O write() 不稳定的原因，正是容器在限制内存之后，Page Cache 的数量较小并且不断申请释放。</p><p>其实这个问题也提醒了我们：在对容器做 Memory Cgroup 限制内存大小的时候，不仅要考虑容器中进程实际使用的内存量，还要考虑容器中程序 I/O 的量，合理预留足够的内存作为 Buffered I/O 的 Page Cache。</p><p>比如，如果知道需要反复读写文件的大小，并且在内存足够的情况下，那么 MemoryCgroup 的内存限制可以超过这个文件的大小。</p><p>还有一个解决思路是，我们在程序中自己管理文件的 cache 并且调用 Direct I/O 来读写文件，这样才会对应用程序的性能有一个更好的预期。</p><h2 id=网络>网络</h2><h3 id=容器网络>容器网络</h3><p>Network Namespace可以隔离网络设备，ip协议栈，ip路由表，防火墙规则等，以及可以显示独立的网络状态信息</p><p>我们可以通过clone()或者unshare()系统调用来简历新的network namespace。</p><p>此外，还有一些工具“ip netns”，“unshare”，“lsns”和“nsenter”也可以操作。
<img src=./network_%E5%B7%A5%E5%85%B7%E5%8C%85.jpeg alt=network_工具包></p><h4 id=如何修改容器中的网络参数>如何修改容器中的网络参数</h4><p>由于安全原因，普通容器的/proc/sys/是简历在容器文件系统底层的，是read-only mount的，所以在容器启动以后，我们无法在容器内部修改/proc/sys/net下的网络相关的参数。</p><p>如果需要修改，需要通过runC sysctl相关的接口，在容器启动的时候对容器内部的网络参数做配置。</p><p>docker：加上&ndash;sysctl参数</p><p>k8s：需要allowed unsafe sysctl特性</p><h4 id=如何配置容器网络接口>如何配置容器网络接口</h4><p>且如何在容器不通的时候，如何简单测试</p><p>思考下让容器中的数据包最终发送到物理网卡上，需要哪些步骤</p><ol><li>数据包从容器的network namespace发送到host network namespace上</li><li>数据发到host network namespace之后，还要解决数据包怎么从宿主机上eth0发送出去的问题</li></ol><p>先解决第一步从容器到宿主机的network namespace有哪些方式呢？</p><ol><li>veth</li><li>macvlan/ipvlan</li></ol><p>在docker启动的容器缺省的默认网络接口模式是veth</p><p>veth是一个虚拟的网络设备，一般都是成对创建的，而且这对设备是相互连接的，当每个设备在不同的network namespaces的时候，namespace之间就可以用这对veth进行网络通讯了。</p><p>使用veth进行容器网络发送到宿主机网络了，之后怎么从宿主机eth0发送出去？</p><p>解决方法：</p><ol><li>nat转发</li><li>overlay网络发送</li><li>proxy arp+路由方式</li></ol><p>docker默认使用bridge+nat转发</p><p>重点是，如果网络不通，使用tcpdump找到具体哪一步数据包停止了转发？
Linux命令：tcpdump</p><h4 id=如何优化容器网络时延问题>如何优化容器网络时延问题</h4><p>veth网络接口从配置上看，一个数据包要从容器里发送到宿主机外，需要先从容器里的eth0把包发送到宿主机的veth_host，然后再从宿主机上通过nat或者路由的方式，经过宿主机的eth0向外发送。</p><p><img src=./veth%E7%BD%91%E7%BB%9C1.jpeg alt>
这种容器向外发送数据包的路径，相比宿主机直接向外发送数据包的路径，明显多了一次接口层的发送和接收，增加开销</p><p>如果程序对网络性能有很高要求，如何解决呢？</p><p>可以使用netperf模拟测试下网络迟延问题</p><p>Linux命令：netperf</p><p>可以换成其他网络噢诶之模式，比如macvlan或者ipvlan</p><p>原理：在物理的网络接口上配置几个虚拟的网路接口，配置独立的ip，这些ip可以属于不同的namespace。</p><p>不同点：macvlan有独立的mac地址，而ipvlan是所有共享一个mac地址</p><p>缺点：由于ipvlan/macvlan网络接口直接挂在物理网络接口上，对于需要使用iptables规则的容器，比如k8s使用service服务的容器就不能工作了。</p><h4 id=乱序重传问题>乱序重传问题</h4><p>veth接口会不会引起乱序重传？原因是什么？如何解决？
Linux命令：iperf3</p><p>数据包重传可能原因：</p><ol><li>数据包网络中丢了</li><li>数据包乱序</li></ol><p>使用tcpdump抓包量比较大，额外系统开销也比较大
可以使用netstat进行查看协议栈中丢包和重传的情况
可以看到 fast retransmits （快速回传）</p><p>快速回传：如果发送端收到3个重复的ack，那么发送端就可以立刻重新发送ack对应的下一个数据包，而不用等待发送超时。</p><p>通过对veth网络接口研究，我们知道他可能增加数据包乱序的几率。</p><p>RPS和RSS作用类似，都是把数据包分散到更多的CPU上进行处理，使得系统有更强的网络报处理能力。他们的区别是RSS工作在网卡的硬件层，而RPS工作在Linux内核的软件层。</p><p>在把数据包分散到各个cpu时，RPS保证了同一个数据流是在同一个CPU上的，这样就可以有效减少包的乱序。那么我们可以把RPS的这个特性配置到veth网络接口上，来减少数据包乱序的几率</p><p>但是RPS配置还是会带来额外的系统开销，在某些网络环境中会引起softriq CPU使用率的增加大。是否开启需要根据场景进行评估。</p><p>同时tcp的乱序包也不一样会产生数据包的回传。想要减少网络包的回传也可以参考协议栈的其他参数设置，如/proc/sys/net/ipv4/tcp_reordering。</p><p>另外使用http2.0可以有效减少回传。</p><h3 id=容器安全>容器安全</h3><p>运行容器的时候，在安全方面可以做哪些？</p><ol><li>赋予容器合理的capabilities</li><li>在容器中以非root用户运行程序</li></ol><p>使用系统命令但没有权限，即时以root？为什么？因为执行需要capabilities，只要在启动的时候，需要加上privileged参数</p><h4 id=linux-capabilities>Linux capabilities</h4><p>Linux命令：capsh
capabilities：简单来说对应任意一个进程，在做任意一个特权操作的时候，都需要有这个特权操作对应的capability。就是吧linux root用户原来所有的特权做了细化，可以更加细粒度的给进程赋予不同的权限。</p><p>但是也不能直接给容器直接设置成privileged，也就是把所有capability都赋予容器，否则容器就可以直接修改宿主机上的所有文件了。</p><p>可以按需给与，比如需要iptables，可以设置 &ndash;cap-add NET_ADMIN就可以了</p><h4 id=root模式>root模式</h4><p>尽管容器中的root用户的linux capabilities已经减少很多，但是在没有没有User Namespace的情况下，容器中的root用户和宿主机上的root用户的uid是完全相同的，一旦有软件的漏洞，容器中的root用户就可以操作整个宿主机。</p><p>为了减少安全风险，业界都见识在容器中以非root用户来运行进程，不过在没有 USer Namespace的情况下，容器中使用给root用户，对容器云平台来说，对uid的管理会比较麻烦。</p><p>所以，我们分析下User Namespace，它带来的好处有两个。一个是吧容器中的root用户映射成宿主机上的普通用户，另外一个好处是在云平台里对容器的uid分配较为容易。</p><p>除了在容器中以非root用户来运行进程外，docker和podman都已经支持rootless container，进一步降低了容器的安全风险。</p><p>学习自：极客时间-容器实战高手
待补充实战课</p></div><footer class=post-footer><div class=post-tags><a href=/tags/%e6%8a%80%e6%9c%af rel=tag title=技术>#技术#</a>
<a href=/tags/%e5%ae%b9%e5%99%a8 rel=tag title=容器>#容器#</a>
<a href=/tags/docker rel=tag title=docker>#docker#</a></div><div class=addthis_inline_share_toolbox></div><div class=post-nav><div class=article-copyright><div class=article-copyright-img><img src=/img/qq_qrcode.png width=129px height=129px><div style=text-align:center>QQ扫一扫交流</div></div><div class=article-copyright-info><p><span>声明：</span>容器学习笔记</p><p><span>链接：</span>/post/docker_learn_note/</p><p><span>作者：</span>菩提本树</p><p><span>声明： </span>本博客文章除特别声明外，均采用 <a href=https://creativecommons.org/licenses/by-nc-sa/3.0/ target=_blank style=text-decoration:underline>CC BY-NC-SA 3.0</a>许可协议，转载请注明出处！</p></div></div><div class=clear></div></div><div class=reward-qr-info><div>创作实属不易，如有帮助，那就打赏博主些许茶钱吧 ^_^</div><button id=rewardButton disable=enable onclick="var qr=document.getElementById('QR');qr.style.display==='none'?qr.style.display='block':qr.style.display='none'">
<span>赏</span></button><div id=QR style=display:none><div id=wechat style=display:inline-block><img id=wechat_qr src=/img/wechat-pay.png alt="WeChat Pay"><p>微信打赏</p></div><div id=alipay style=display:inline-block><img id=alipay_qr src=/img/ali-pay.png alt=Alipay><p>支付宝打赏</p></div></div></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/post/k8s/ rel=next title=K8s学习笔记><i class="fa fa-chevron-left"></i> K8s学习笔记</a></div><div class="post-nav-prev post-nav-item"></div></div></footer></article></section></div></div><div class=sidebar-toggle><div class=sidebar-toggle-line-wrap><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id=sidebar class=sidebar><div class=sidebar-inner><section class="site-overview sidebar-panel sidebar-panel-active"><div class="site-author motion-element" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image src=/img/avatar.png alt=菩提本树><p class=site-author-name itemprop=name>菩提本树</p><p class="site-description motion-element" itemprop=description>工作是一种乐趣时，生活是一种享受!</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href=/post/><span class=site-state-item-count>2</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>1</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>4</span>
<span class=site-state-item-name>标签</span></a></div></nav><div class="links-of-author motion-element"><span class=links-of-author-item><a href=https://github.com/jansonlv/ target=_blank title=GitHub><i class="fa fa-fw fa-github"></i>
GitHub</a></span>
<span class=links-of-author-item><a href=https://www.zhihu.com target=_blank title=知乎><i class="fa fa-fw fa-globe"></i>
知乎</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-inline"><div class=links-of-blogroll-title><i class="fa fa-fw fa-globe"></i>
友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://gohugo.io/ title=hugo target=_blank>hugo</a></li><li class=links-of-blogroll-item><a href=https://lisenhui.cn/ title=凡梦星尘 target=_blank>凡梦星尘</a></li><li class=links-of-blogroll-item><a href=https://tech.qimao.com/ title=qimao target=_blank>qimao</a></li><li class=links-of-blogroll-item><a href=https://www.liaoxuefeng.com/ title=廖雪峰 target=_blank>廖雪峰</a></li></ul></div><div class="tagcloud-of-blogroll motion-element tagcloud-of-blogroll-inline"><div class=tagcloud-of-blogroll-title><i class="fa fa-fw fa-tags"></i>
标签云</div><ul class=tagcloud-of-blogroll-list><li class=tagcloud-of-blogroll-item><a href=/tags/docker>Docker</a></li><li class=tagcloud-of-blogroll-item><a href=/tags/%E5%AE%B9%E5%99%A8>容器</a></li><li class=tagcloud-of-blogroll-item><a href=/tags/%E6%8A%80%E6%9C%AF>技术</a></li><li class=tagcloud-of-blogroll-item><a href=/tags/k8s>K8s</a></li></ul></div><div class="links-of-blogroll motion-element inline"><script type=text/javascript src="//rf.revolvermaps.com/0/0/6.js?i=Your%20RevolverMapId&m=7&c=e63100&cr1=ffffff&f=arial&l=0&bv=90&lx=-420&ly=420&hi=20&he=7&hc=a8ddff&rs=80" async></script></div></section></div></aside></div></main><footer id=footer class=footer><div class=footer-inner><div class=copyright><span class=copyright-year>&copy; 2010 - 2021</span>
<span class=with-love><i class="fa fa-heart"></i></span>
<span class=copyright-author>现实和梦想</span></div><div class=powered-info><span class=powered-by>Powered by - <a class=powered-link href=//gohugo.io target=_blank title=hugo>Hugo v0.83.1</a></span>
<span class=separator-line>/</span>
<span class=theme-info>Theme by - <a class=powered-link href=//github.com/elkan1788/hugo-theme-next target=_blank>NexT</a></span></div><div class=vistor-info><span class=cnzz_icon id="cnzz_stat_icon_Your CNNZSiteId"><a href="//www.cnzz.com/stat/website.php?web_id=Your%20CNNZSiteId" target=_blank title=站长统计><img border=0 hspace=0 vspace=0 src=//icon.cnzz.com/img/pic1.gif></a></span>
<script type=text/javascript>(function(){var a=document.createElement('script'),b;a.type='text/javascript',a.async=!0,a.charset='utf-8',a.src='https://s4.cnzz.com/z_stat.php?id=Your CNNZSiteId&show=pic1',b=document.getElementsByTagName('script')[0],b.parentNode.insertBefore(a,b)})()</script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><span class=site-uv><i class="fa fa-user"></i>
<span class=busuanzi-value id=busuanzi_value_site_uv></span></span><span class=separator-line>/</span>
<span class=site-pv><i class="fa fa-eye"></i>
<span class=busuanzi-value id=busuanzi_value_site_pv></span></span></div><div class=license-info><span class=storage-info>Storage by
<a href=github.com style=font-weight:700 target=_blank>github.com</a></span>
<span class=separator-line>/</span>
<span class=license-num><a href=github.io target=_blank>github.io</a></span></div></div></footer><div class=back-to-top><i class="fa fa-arrow-up"></i>
<span id=scrollpercent><span>0</span>%</span></div></div><script type=text/javascript src=//cdn.bootcdn.net/ajax/libs/jquery/2.1.4/jquery.min.js></script><script type=text/javascript src=/js/search.js></script><script type=text/javascript src=/js/affix.js></script><script type=text/javascript src=/js/scrollspy.js></script><script type=text/javascript>function getCntViewHeight(){var b=$('#content').height(),a=$(window).height(),c=b>a?b-a:$(document).height()-a;return c}function getScrollbarWidth(){var a=$('<div />').addClass('scrollbar-measure').prependTo('body'),b=a[0],c=b.offsetWidth-b.clientWidth;return a.remove(),c}function registerBackTop(){var b=50,a=$('.back-to-top');$(window).on('scroll',function(){var d,e,f,c,g;a.toggleClass('back-to-top-on',window.pageYOffset>b),d=$(window).scrollTop(),e=getCntViewHeight(),f=d/e,c=Math.round(f*100),g=c>100?100:c,$('#scrollpercent>span').html(g)}),a.on('click',function(){$("html,body").animate({scrollTop:0,screenLeft:0},800)})}function initScrollSpy(){var a='.post-toc',d=$(a),b='.active-current';d.on('activate.bs.scrollspy',function(){var b=$(a+' .active').last();c(),b.addClass('active-current')}).on('clear.bs.scrollspy',c),$('body').scrollspy({target:a});function c(){$(a+' '+b).removeClass(b.substring(1))}}function initAffix(){var a=$('.header-inner').height(),b=parseInt($('.main').css('padding-bottom'),10),c=a+10;$('.sidebar-inner').affix({offset:{top:c,bottom:b}}),$(document).on('affixed.bs.affix',function(){updateTOCHeight(document.body.clientHeight-100)})}function initTOCDimension(){var a,b;$(window).on('resize',function(){a&&clearTimeout(a),a=setTimeout(function(){var a=document.body.clientHeight-100;updateTOCHeight(a)},0)}),updateTOCHeight(document.body.clientHeight-100),b=getScrollbarWidth(),$('.post-toc').css('width','calc(100% + '+b+'px)')}function updateTOCHeight(a){a=a||'auto',$('.post-toc').css('max-height',a)}$(function(){var b=$('.header-inner').height()+10,c,d,a,e;$('#sidebar').css({'margin-top':b}).show(),c=$('.header-inner').height(),d=$('.sidebar-inner').height(),a=c+d+50,e=$('.content-wrap').height(),e<a&&$('.content-wrap').css('height',a+50),$('.site-nav-toggle').on('click',function(){var a=$('.site-nav'),e=$('.toggle'),b='site-nav-on',f='toggle-close',c=a.hasClass(b),g=c?'slideUp':'slideDown',d=c?'removeClass':'addClass';a.stop()[g]('normal',function(){a[d](b),e[d](f)})}),registerBackTop(),initScrollSpy(),initAffix(),initTOCDimension(),$('.sidebar-nav-toc').click(function(){$(this).addClass('sidebar-nav-active'),$(this).next().removeClass('sidebar-nav-active'),$('.'+$(this).next().attr('data-target')).toggle(500),$('.'+$(this).attr('data-target')).toggle(500)}),$('.sidebar-nav-overview').click(function(){$(this).addClass('sidebar-nav-active'),$(this).prev().removeClass('sidebar-nav-active'),$('.'+$(this).prev().attr('data-target')).toggle(500),$('.'+$(this).attr('data-target')).toggle(500)})})</script><script src=//cdn.bootcdn.net/ajax/libs/imageviewer/0.1.0/viewer.min.js></script><script type=text/javascript>$(function(){$('.post-body').viewer()})</script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=Your%20AddthisId"></script><script>(function(){var a=document.createElement('script'),c=window.location.protocol.split(':')[0],b;c==='https'?a.src='https://zz.bdstatic.com/linksubmit/push.js':a.src='http://push.zhanzhang.baidu.com/push.js',b=document.getElementsByTagName("script")[0],b.parentNode.insertBefore(a,b)})()</script><script type=text/javascript>$(function(){var b,a;document.body.clientWidth>900&&(b=document.getElementsByTagName('HEAD').item(0),a=document.createElement("script"),a.type="text/javascript",a.innerHTML='(function(i,s,o,g,r,a,m){i["DaoVoiceObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;a.charset="utf-8";m.parentNode.insertBefore(a,m)})(window,document,"script",(\'https:\' == document.location.protocol ? \'https:\' : \'http:\') + "//widget.daovoice.io/widget/Your DaoVoiceId.js","daovoice")',b.appendChild(a),daovoice('init',{app_id:"Your DaoVoiceId"}),daovoice('update'))})</script></body></html>